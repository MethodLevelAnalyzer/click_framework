<bean cache="catalog_book">
    <validation>
      <group name="create,update"><![CDATA[
        ${this.assertNotEmpty("title")}
      ]]></group>
      <group name="create"><![CDATA[
      ]]></group>
    </validation>
    <read name="id"><![CDATA[
        select
          id as "id",
          title as "title",
          author as "author",
          editor as "editor",
          state as "state",
          description as "description",
          has_cover as "hasCover",
          price as "price",
          publication_date as "publicationDate",
          promo_end_date as "promoEndDate",
          promo_description as "promoDescription",
          promo_discount as "promoDiscount",
          promo_last_modified as "promoLastModified",
          creation_date as "creationDate",
          last_modified as "lastModified"
        from
          io_book
        where
          id = ${this.id}
    ]]></read>
    <read-list name="booksets"><![CDATA[
      select id as "id" from io_bookset where book_id = ${this.id}
    ]]></read-list>
    <read-list name="events"><![CDATA[
      select id as "id" from io_event where book_id = ${this.id}
    ]]></read-list>
    <read-list name="links"><![CDATA[
      select id as "id" from io_link where book_id = ${this.id}
    ]]></read-list>
    <read-list name="bookandgets"><![CDATA[
      select id as "id" from io_bookandget where book_id = ${this.id}
    ]]></read-list>
    <read-list name="userlibraries"><![CDATA[
      select id as "id" from io_userlibrary where book_id = ${this.id}
    ]]></read-list>
    <read-list name="userratings"><![CDATA[
      select id as "id" from io_userrating where book_id = ${this.id}
    ]]></read-list>
    <read-list name="comments"><![CDATA[
      select id as "id" from io_comment where book_id = ${this.id}
    ]]></read-list>
    <read-list name="useractions"><![CDATA[
      select id as "id" from io_useraction where book_id = ${this.id}
    ]]></read-list>

    <read name="title"><![CDATA[
      select
        id as "id"
      from
        io_book
      where
        lower(title) = lower(${this.title})
    ]]></read><read name="author"><![CDATA[
      select
        id as "id"
      from
        io_book
      where
        lower(author) = lower(${this.author})
    ]]></read><read name="editor"><![CDATA[
      select
        id as "id"
      from
        io_book
      where
        lower(editor) = lower(${this.editor})
    ]]></read>
    <update><![CDATA[
        update io_book
        set
          title = ${this.title},
          author = ${this.author},
          editor = ${this.editor},
          state = ${this.state},
          description = ${this.description},
          has_cover = ${this.hasCover},
          price = ${this.price},
          publication_date = ${this.publicationDate},
          promo_end_date = ${this.promoEndDate},
          promo_description = ${this.promoDescription},
          promo_discount = ${this.promoDiscount},
          promo_last_modified = ${this.promoLastModified},
          last_modified = ${this.now()}
        where
          id = ${this.id}
    ]]></update>
    <execute name="touch"><![CDATA[
        update io_book
        set
          last_modified = ${this.now()}
        where
          id = ${this.id}
    ]]></execute>
    <create><![CDATA[
        insert into io_book (
          [#if this.bean.id??]id,[/#if]
          title,
          author,
          editor,
          state,
          description,
          has_cover,
          price,
          publication_date,
          promo_end_date,
          promo_description,
          promo_discount,
          promo_last_modified,
          creation_date,
          last_modified
        ) values (
          [#if this.bean.id??]${this.id},[/#if]
          ${this.title},
          ${this.author},
          ${this.editor},
          ${this.state},
          ${this.description},
          ${this.hasCover},
          ${this.price},
          ${this.publicationDate},
          ${this.promoEndDate},
          ${this.promoDescription},
          ${this.promoDiscount},
          ${this.promoLastModified},
          [#if this.bean.creationDate??]${this.creationDate}[#else]${this.now()}[/#if],
          [#if this.bean.lastModified??]${this.lastModified}[#else]${this.now()}[/#if]
        )
    ]]></create>
    <delete><![CDATA[
      delete from
        io_book
      where
        id = ${this.id}
    ]]></delete>
    <curr-val><![CDATA[
        select LAST_INSERT_ID() as id
    ]]></curr-val>
</bean>
