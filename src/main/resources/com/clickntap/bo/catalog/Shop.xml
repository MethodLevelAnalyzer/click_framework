<bean cache="catalog_shop">
    <validation>
      <group name="create,update"><![CDATA[
        ${this.assertNotEmpty("name")}
        ${this.assertNotEmpty("address")}
        ${this.assertNotEmpty("city")}
        ${this.assertNotEmpty("cityCode")}
        ${this.assertNotEmpty("phone")}
      ]]></group>
      <group name="create"><![CDATA[
      ]]></group>
    </validation>
    <read name="id"><![CDATA[
        select
          id as "id",
          name as "name",
          address as "address",
          city as "city",
          city_code as "cityCode",
          phone as "phone",
          latitude as "latitude",
          longitude as "longitude",
          creation_date as "creationDate",
          last_modified as "lastModified"
        from
          io_shop
        where
          id = ${this.id}
    ]]></read>
    <read-list name="events"><![CDATA[
      select id as "id" from io_event where shop_id = ${this.id}
    ]]></read-list>
    <read-list name="bookandgets"><![CDATA[
      select id as "id" from io_bookandget where shop_id = ${this.id}
    ]]></read-list>
    <read-list name="bookers"><![CDATA[
      select id as "id" from io_user where shop_id = ${this.id}
    ]]></read-list>
    <read-list name="users"><![CDATA[
      select id as "id" from io_user where favorite_shop_id = ${this.id}
    ]]></read-list>

    <read name="name"><![CDATA[
      select
        id as "id"
      from
        io_shop
      where
        lower(name) = lower(${this.name})
    ]]></read><read name="address"><![CDATA[
      select
        id as "id"
      from
        io_shop
      where
        lower(address) = lower(${this.address})
    ]]></read><read name="city"><![CDATA[
      select
        id as "id"
      from
        io_shop
      where
        lower(city) = lower(${this.city})
    ]]></read><read name="city_code"><![CDATA[
      select
        id as "id"
      from
        io_shop
      where
        lower(city_code) = lower(${this.cityCode})
    ]]></read><read name="phone"><![CDATA[
      select
        id as "id"
      from
        io_shop
      where
        lower(phone) = lower(${this.phone})
    ]]></read>
    <update><![CDATA[
        update io_shop
        set
          name = ${this.name},
          address = ${this.address},
          city = ${this.city},
          city_code = ${this.cityCode},
          phone = ${this.phone},
          latitude = ${this.latitude},
          longitude = ${this.longitude},
          last_modified = ${this.now()}
        where
          id = ${this.id}
    ]]></update>
    <execute name="touch"><![CDATA[
        update io_shop
        set
          last_modified = ${this.now()}
        where
          id = ${this.id}
    ]]></execute>
    <create><![CDATA[
        insert into io_shop (
          [#if this.bean.id??]id,[/#if]
          name,
          address,
          city,
          city_code,
          phone,
          latitude,
          longitude,
          creation_date,
          last_modified
        ) values (
          [#if this.bean.id??]${this.id},[/#if]
          ${this.name},
          ${this.address},
          ${this.city},
          ${this.cityCode},
          ${this.phone},
          ${this.latitude},
          ${this.longitude},
          [#if this.bean.creationDate??]${this.creationDate}[#else]${this.now()}[/#if],
          [#if this.bean.lastModified??]${this.lastModified}[#else]${this.now()}[/#if]
        )
    ]]></create>
    <delete><![CDATA[
      delete from
        io_shop
      where
        id = ${this.id}
    ]]></delete>
    <curr-val><![CDATA[
        select LAST_INSERT_ID() as id
    ]]></curr-val>
</bean>
